<!--pages/record/record.wxml-->
<view class="container">
  <!-- å›ºå®šé¡¶éƒ¨çš„å¯¼èˆªæ  + å†å²æˆ˜ç»© + æ•°æ®å¡ç‰‡ -->
  <view class="fixed-header">
    <!-- ä»…å±•ç¤ºæ ‡é¢˜çš„ navigation-bar ç»„ä»¶ -->
    <navigation-bar title="Identity V"></navigation-bar>

    <!-- ç‹¬ç«‹çš„å†å²æˆ˜ç»©æ  -->
    <view class="history-bar">
      <text class="history-title">å†å²æˆ˜ç»©</text>
      <view class="history-actions">
        <view class="action-btn refresh-btn" bindtap="onRefresh">
          <text class="icon">ğŸ”„</text>
        </view>
        <view class="action-btn add-btn" bindtap="onAdd">
          <text class="icon">+</text>
        </view>
      </view>
    </view>

    <!-- æ•°æ®æ¦‚è§ˆå¡ç‰‡ -->
    <view class="stats-card">
      <view class="stats-row">
        <text class="stats-label">ç›‘ç®¡è€…èƒœç‡ï¼š{{hunterStats.winRate}}</text>
        <text class="stats-sub">å¸¸ç”¨è§’è‰²ï¼š{{hunter.career}}</text>
      </view>
      <view class="stats-row">
        <text class="stats-label">æ±‚ç”Ÿè€…èƒœç‡ï¼š{{survivorStats.winRate}}</text>
        <text class="stats-sub">å¸¸ç”¨è§’è‰²ï¼š{{survivor.career}}</text>
      </view>
      <!-- æ’è¡Œæ¦œæŒ‰é’® -->
      <view class="rank-btn" bindtap="onRankClick">
        <text class="rank-btn-text">æ’è¡Œæ¦œ</text>
      </view>
    </view>
  </view>

  <!-- å¯æ»‘åŠ¨çš„æˆ˜ç»©åˆ—è¡¨ï¼ˆç•™å‡ºé¡¶éƒ¨å›ºå®šåŒºåŸŸçš„é—´è·ï¼‰ -->
  <scroll-view class="record-list-container" scroll-y="true">
    <view class="tip" wx:if="{{!records.length}}">
    æš‚æ— å†å²æˆ˜ç»©
    </view>
    <view class="record-list">
      <block wx:for="{{records}}" wx:key="game_id">
        <view class="record-item {{item.type}}"
        bindlongpress="onRecordLongPress" 
              data-index="{{index}}"  
              data-record="{{item}}">
          <!-- æˆ˜ç»©å¤´éƒ¨ -->
          <view class="record-header" bindtap="toggleExpand" data-index="{{index}}">
            <text class="record-role">{{item.role}}</text>
            <view class="header-right">
              <text class="record-result">{{item.result}}</text>
              <text class="expand-btn">{{item.expanded ? 'â–²' : 'â–¼'}}</text>
            </view>
          </view>

          <!-- æˆ˜ç»©è¯¦æƒ… -->
          <view class="record-detail" wx:if="{{item.expanded}}">
            <block wx:for="{{item.details}}" wx:for-item="detail" wx:key="detailKey">
              <view class="detail-item">
                <text class="detail-icon">{{detail.role.includes('ç›‘ç®¡') ? 'ğŸ‘ï¸' : 'ğŸ‘¤'}}</text>
                <text class="detail-text" 
                bindtap="onShowRoleTalents"
                data-pure-role="{{detail.pureRole}}"
                data-talent="{{detail.talent}}">
                {{detail.pureRole}}
                </text>
                <text class="detail-tag {{detail.tag.includes('å…¨èƒœ') || detail.tag.includes('é€ƒè„±') ? 'win-tag' : 'lose-tag'}}">{{detail.tag}}</text>
              </view>
            </block>
          </view>
        </view>
      </block>
    </view>
  </scroll-view>

  <!-- æ–°å¢ï¼šè‡ªå®šä¹‰ä¿®æ”¹å¼¹çª—ï¼ˆé»˜è®¤éšè—ï¼‰ -->
  <view class="edit-modal {{showEditModal ? 'show' : ''}}" wx:if="{{showEditModal}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">ä¿®æ”¹</text>
        <view class="modal-close" bindtap="closeEditModal">âœ•</view>
      </view>

      <!-- ç›‘ç®¡è€…éƒ¨åˆ† -->
      <view class="modal-section">
        <text class="section-label">ç›‘ç®¡è€…ï¼š</text>
        <view class="tag-group">
          <view class="tag-item" bindtap="onSelectKillerRole" >{{editKillerRole || 'æœªé€‰æ‹©'}}</view>
        </view>
        <text class="section-sub">æºå¸¦å¤©èµ‹ï¼š</text>
        <view class="tag-group">
          <view class="tag-item" bindtap="onSelectKillerTalent" 
          data-index="0">{{editKillerTalents[0] || 'æœªé€‰æ‹©'}}</view>
          <view class="tag-item" bindtap="onSelectKillerTalent" data-index="1">{{editKillerTalents[1] || 'æœªé€‰æ‹©'}}</view>
        </view>
      </view>

      <!-- æ±‚ç”Ÿè€…éƒ¨åˆ†ï¼ˆå¾ªç¯æ˜¾ç¤ºï¼‰ -->
      <view class="modal-section" wx:for="{{editDetails}}" wx:key="index" wx:for-index="surIndex">
        <text class="section-label">æ±‚ç”Ÿè€…{{surIndex + 1}}ï¼š</text>
        <view class="tag-group">
          <view class="tag-item" bindtap="onSelectSurvivorResult" data-index="{{surIndex}}" >{{item.result || 'æœªé€‰æ‹©'}}</view>
          <view class="tag-item" bindtap="onSelectSurvivorRole" data-index="{{surIndex}}" >{{item.survivor || 'æœªé€‰æ‹©'}} </view>
        </view>
        <text class="section-sub">æºå¸¦å¤©èµ‹ï¼š</text>
        <view class="tag-group">
          <view class="tag-item" bindtap="onSelectSurvivorTalent" data-index="{{surIndex}}"data-talent-index="0" >{{item.talents[0] || 'æœªé€‰æ‹©'}}</view>
          <view class="tag-item" bindtap="onSelectSurvivorTalent" data-index="{{surIndex}}"data-talent-index="1" >{{item.talents[1] || 'æœªé€‰æ‹©'}}</view>
        </view>
      </view>

      <view class="modal-actions">
        <view class="action-btn confirm" bindtap="confirmEdit">ç¡®è®¤</view>
        <view class="action-btn cancel" bindtap="closeEditModal">å–æ¶ˆ</view>
      </view>
    </view>
  </view>
<!-- æ–°å¢ï¼šè§’è‰²å¤©èµ‹è¯¦æƒ…å¼¹çª— -->
<view class="role-talent-modal {{showRoleTalentModal ? 'show' : ''}}" wx:if="{{showRoleTalentModal}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">è¯¦æƒ…</text>
      </view>
      <view class="modal-tip">
        <text>å•å‡»è§’è‰²æˆ–å¤©èµ‹å¯è¿›å…¥ç›¸å…³è¯¦æƒ…é¡µ</text>
      </view>
      <view class="modal-section">
        <text class="section-label">è§’è‰²ï¼š</text>
        <view class="tag-group">
          <view class="tag-item">{{currentRoleName}}</view>
        </view>
        <text class="section-sub">å¤©èµ‹1ï¼š</text>
        <view class="tag-group">
          <view class="tag-item">{{currentRoleTalents[0]}}</view>
        </view>
        <text class="section-sub">å¤©èµ‹2ï¼š</text>
        <view class="tag-group">
          <view class="tag-item">{{currentRoleTalents[1]}}</view>
        </view>
      </view>
      <view class="modal-actions">
        <view class="action-btn confirm" bindtap="closeRoleTalentModal">å…³é—­</view>
      </view>
    </view>
  </view>
  <!-- åº•éƒ¨é€‰æ‹©å™¨ï¼ˆå¿…é¡»æ”¾åœ¨WXMLæœ€åï¼Œé¿å…è¢«é®æŒ¡ï¼‰ -->
  <view class="bottom-picker {{showBottomPicker ? 'show' : ''}}">
    <view class="picker-header">
      <text bindtap="closeBottomPicker">å–æ¶ˆ</text>
      <text bindtap="confirmBottomPicker">ç¡®å®š</text>
    </view>
    <picker-view value="{{pickerValue}}" bindchange="onPickerChange" style="width: 100%; height: 300rpx;">
      <picker-view-column>
        <view wx:for="{{pickerOptions}}" wx:key="*this" style="line-height: 50rpx; text-align: center;">
          {{item}}
        </view>
      </picker-view-column>
    </picker-view>
  </view>
</view>